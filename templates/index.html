<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Subnet Calculator + Terraform Generator</title>
  <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h2>Subnet Calculator</h2>
    <form method="POST">
      {{ form.hidden_tag() }}
      <label>{{ form.ip_address.label }}</label>
      {{ form.ip_address(size=32) }}
      <label>{{ form.cidr_mask.label }}</label>
      {{ form.cidr_mask() }}
      <label>{{ form.split_mask.label }}</label>
      {{ form.split_mask() }}
      <label>{{ form.cloud_provider.label }}</label>
      {{ form.cloud_provider() }}
      {{ form.submit(class_='btn') }}
    </form>

    {% if form.errors %}
      <div class="error">
        <ul>
        {% for field, errors in form.errors.items() %}
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if result %}
    <div class="result">
      {% for key, value in result.items() %}
        {% if key == 'Cloud Compatibility Warnings' %}
          <div><strong>{{ key }}:</strong>
            <ul>{% for w in value %}<li>{{ w }}</li>{% endfor %}</ul>
          </div>
        {% elif key not in ['total_hosts','usable_hosts'] %}
          <div><strong>{{ key }}:</strong> {{ value }}</div>
        {% endif %}
      {% endfor %}

      <a href="{{ url_for('export', format='csv', ip=form.ip_address.data, cidr=form.cidr_mask.data) }}" class="btn-export">Download CSV</a>
      <a href="{{ url_for('export', format='json', ip=form.ip_address.data, cidr=form.cidr_mask.data) }}" class="btn-export">Download JSON</a>
      <a href="{{ url_for('download_tf', ip=form.ip_address.data, cidr=form.cidr_mask.data, provider=form.cloud_provider.data) }}" class="btn-export" style="background:#343a40;">Download .tf</a>
      <button id="show-tf" onclick="document.getElementById('tf-block').style.display='block'" class="btn-export" style="background:#6f42c1;">Show Terraform</button>

      <div id="tf-block" style="display:none;">
        <label><strong>Terraform Config:</strong></label>
        <textarea id="tf-template" rows="12">{{ tf_template }}</textarea>
        <button id="copy-tf" class="btn-export" style="background:#17a2b8;">Copy TF</button>
      </div>
    </div>
    {% endif %}

    {% if subnets %}
    <h3>Split Subnets</h3>
    <table>
      <tr><th>#</th><th>Subnet</th><th>First IP</th><th>Last IP</th><th>Broadcast</th></tr>
      {% for sn in subnets %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ sn }}</td>
        <td>{{ sn.network_address + 1 if sn.num_addresses>2 else sn.network_address }}</td>
        <td>{{ sn.broadcast_address - 1 if sn.num_addresses>2 else sn.broadcast_address }}</td>
        <td>{{ sn.broadcast_address if sn.version==4 else 'N/A' }}</td>
      </tr>
      {% endfor %}
    </table>
    {% endif %}
  </div>
  <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
